---
title: "RAS signature Survival Analysis Validation : Project 002"
author: "philip.east@crick.ac.uk"
date: "12/02/2019"
output: 
  html_document:
   code_folding: hide
   df_print: tibble
   toc: true
   toc_depth: 5
   toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,warning=FALSE,message=FALSE)
```

Survival analysis across TCGA LUAD RAS activity groups.

```{r}
library( affy )
library( limma )
library( org.Hs.eg.db )
library( pheatmap )
library( clusterProfiler )
library( survival )
library( gplots )
library( ggplot2 )
library( xlsx )
library( survminer )
library( DESeq2 )
library( dplyr )
library( GEOquery )
library( tibble )
library( tidyverse )
library( DT )
library( Seurat )
library( ComplexHeatmap )
library( circlize )
library( ggrepel )
library( openxlsx )
library( rms )
library( caret )
library( vcd )
library( coxphMIC )
```

# Introduction

Here we run survival analyses across five RAS activity patient groups
(RSG - RAS Signature Group) and a continuous per patient measure of
RAS activity (RSI - RAS Signature Index value) previously dervied from
TGCA LUAD and Uppsala adenocarcinoma 
[GSE81089](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE81089)
cohorts. We show a significant association between an increase in RAS
activity and poor outcome in the TGCA and Uppsala cohorts. In the Uppsala
cohort we show a significant association after correcting for clincal
factors known to be associated with outcome via multivariate Cox
proportional hazard modeling.

# TCGA LUAD cohort

Here we run a univariate coxph proportional hazard analysis on TCGA
LUAD patient overall survival data. We test RSG and RSI as predictors
of overall survival in these patients. 

## Data

Here we read in preprocessed LUAD data as a SummarizedExperiment object.

```{r data}
se_t_file <- file.path( "data", "se_t.rds" )
se_t <- readRDS( se_t_file )
assay( se_t ) <- round( assay( se_t ) )
assays( se_t )$z <- t( scale( t( scale( assays( se_t )$vst ) ) ) )

cell_imm_lscape_file <- file.path( "data", "1-s2.0-S1074761318301213-mmc2.txt" )
cell_imm_lscape_dat <- read.table( file = cell_imm_lscape_file, sep = "\t", header = TRUE )

df <- colData( se_t ) %>%
          as.data.frame( ) %>%
          left_join( cell_imm_lscape_dat, by = c( "patient" = "TCGA.Participant.Barcode" ) )
colData( se_t ) <- DataFrame( df, row.names = df$rowname )

RAS84_idmap <- read.xlsx( file.path( "data", "RAS84_feature_map.xlsx" ) )
```

## Survival analysis

We run a univariate coxph proportional hazard analysis against RSG and
RSI. The results are shown below.

The clinical data available with TCGA cohorts is limited, limiting the
possibility to run a multivariate analysis. There is stage data for
all patients and smoking status and age are only known in 225/502 patients.

```{r survival_data_TCGA}
pdat <- colData( se_t ) %>%
    as.data.frame( )

colData( se_t ) <- pdat %>%
    mutate( OS = OS ) %>%
    mutate( OS.Time = OS.Time ) %>%
    mutate( PFS = PFI )%>%
    mutate( PFS_time = PFI.Time)%>%
    mutate( age = pdat$subtype_Age.at.diagnosis ) %>%
    mutate( sex = pdat$gender ) %>%
    mutate( tumour_stage = pdat$tumor_stage ) %>%
    DataFrame( row.names = .$rowname )

write.xlsx( colData( se_t )[, c( "RAS84" , "ras_index", "MUT.KRAS", "OS", "OS.Time" ) ],
            file = file.path( adat$analysis.path, "TCGA_LUAD_survival_data.xslx" ) )
```

## coxphMIC TCGA

Here we run coxph with lasso regression to identify the important
covariates.

```{r coxphmic_tcga}
surv_dat <- colData( se_t ) %>%
    as.data.frame( ) %>%
    dplyr::select( barcode, OS, OS.Time )

exprs_dat <- assays( se_t )$vst %>%
    as.data.frame( ) %>%
    rownames_to_column( var = "gene_id" ) %>%
    filter( gene_id %in% RAS84_idmap$TCGA_feature_id ) %>%
    gather( barcode, value, -gene_id ) %>%
    mutate( gene_id = sub( "\\|.*", "", gene_id ) ) %>%
    spread( gene_id, value ) %>%
    column_to_rownames( var = "barcode" )

surv_dat <- surv_dat %>%
    left_join( exprs_dat, by = "barcode", suffix = c( "", "" ) ) %>%
    filter( !is.na( OS.Time ) )

fit.mic <- coxphMIC( formula = Surv( OS.Time, OS )~.-barcode, data = surv_dat, method = "BIC" )

cairo_pdf( file = file.path( adat$plot.path, "coxphMIC_plot.pdf" ),
          width = 5, height = 3 )
print( plot( fit.mic ) )
dev.off( )

coxphMIC_genes <- fit.mic$result %>%
    as.data.frame( ) %>%
    rownames_to_column( var = "gene_symbols" ) %>%
    filter( !is.na( se.beta.MIC ) ) %>%
    pull( gene_symbols )
saveRDS( coxphMIC_genes, file.path( adat$analysis.path, "coxphMIC_genes.rds" ) )
write( coxphMIC_genes, file = file.path( "data", "coxphMIC_11genes.txt" ) )
```
```{r render_coxphmic_tcga}
hmcols <- colorpanel( 1000, "#4066AA", "white", "#E3001A" )
hmmat <- assays( se_t )$vst - rowMedians( assays( se_t )$vst )

hmmat_gs <- hmmat %>%
    as.data.frame( ) %>%
    rownames_to_column( var = "TCGA_feature_id" ) %>%
    left_join( RAS84_idmap[, c( "TCGA_feature_id", "TCGA_gene_symbol" ) ], by = "TCGA_feature_id" ) %>%
    dplyr::select( -TCGA_feature_id ) %>%
    filter( TCGA_gene_symbol %in% coxphMIC_genes ) %>%
    column_to_rownames( var = "TCGA_gene_symbol" ) %>%
    as.matrix( )

hm <- Heatmap( hmmat_gs,
              name = "Expression", 
              clustering_method_rows = "ward.D2",
              clustering_method_columns = "ward.D2",
              show_column_names = FALSE,
              show_row_names = TRUE,
              col = colorRamp2(
                  seq( from = -3, to = 3, length.out = length( hmcols ) ),
                  hmcols ),
              ##column_split = se_t$RAS84,
              row_gap = unit( 1, "mm" ),
              column_title = "coxphMIC 11 genes",
              column_title_gp = gpar( fontsize = 14 ),
              column_names_gp = gpar( fontsize = 8 ),
              show_heatmap_legend = FALSE,
              cluster_row_slices = FALSE,
              row_names_max_width = unit( 10, "mm" ) )
```
```{r MIC_RI}
ri_mic <- data.frame(
    barcode = rownames( exprs_dat ),
    ri_mic = rowMeans( exprs_dat[, coxphMIC_genes ] ) ) %>%
    left_join( as.data.frame( colData( se_t )[, c( "barcode", "ras_index", "RAS84" ) ] ), by = "barcode" )

scatter_gg <- ri_mic %>%
    ggplot( aes( x = ras_index, y = ri_mic ) ) +
    geom_point()

bw_gg <- ri_mic %>%
    ggplot( aes( x = RAS84, y = ri_mic ) ) +
    geom_boxplot() +
    plot_formatter() +
    theme( axis.text.x = element_text( angle = 90, vjust = 0.5, hjust =1 ) )

cairo_pdf( file = file.path( adat$plot.path, "coxphMIC_11_genes_boxplots_TCGA.pdf" ),
          width = 2, height = 3 )
print( bw_gg )
dev.off()
```

## RAS activity coxph analysis

Here we build the coxph model using overall survival data and RSG.

```{r coxph_rasact_tcga}
se_t <- se_t[, !is.na( se_t$OS.Time ) & !is.na( se_t$OS ) ]
RSG_OS_n <- table( se_t$RAS84 )
coxph_fit_OS_rasact_tcga <- coxph( Surv( OS.Time, OS ) ~ RAS84, colData( se_t ) )
coxph_fit_PFS_rasact_tcga <- coxph( Surv( PFS_time, PFS ) ~ RAS84, colData( se_t ) )

coxph_fit_OS_sigs_l <- map( names( sig_name_map ), function( sig ) {
    form <- as.formula( paste( "Surv( OS.Time, OS ) ~", sig ) )
    coxph( form, colData( se_t ) )
} )
names( coxph_fit_OS_sigs_l ) <- names( sig_name_map )

coxph_fit_PFS_sigs_l <- map( names( sig_name_map ), function( sig ) {
    form <- as.formula( paste( "Surv( PFS_time, PFS ) ~", sig ) )
    coxph( form, colData( se_t ) )
} )
names( coxph_fit_PFS_sigs_l ) <- names( sig_name_map )

res <- map( coxph_fit_OS_sigs_l, function( fit ) {
    summary( fit )$coef[, 5 ] %>%
                     as.data.frame( ) %>%
                     rownames_to_column( var = "group" ) %>%
                     mutate( RAG = paste0( "RAG-", 1:4 ) )
} ) %>%
    bind_rows( ) %>%
    mutate( signature = sub( "RAG-\\d", "", group ) ) %>%
    rename( pval = 2 )
write.xlsx( res, file.path( adat$analysis.path, "coxph_fit_OS_allsigs.xlsx" ) )
```


### OS Results table

```{r table_OS_coxph_rasact_tcga}
format_coxph <- function( coxph_fit, factor_name = "" ) {
    res_coef <- as.data.frame( summary( coxph_fit )$coef ) %>%
        rownames_to_column( var = "predictor" ) %>%
        mutate( predictor = sub( factor_name, "", predictor ) ) %>%
        rename( HR = 3, pvalue = 6 )
    res_conf <- as.data.frame( summary( coxph_fit )$conf.int ) %>%
        rownames_to_column( var = "predictor" ) %>%
        mutate( predictor = sub( factor_name, "", predictor ) ) %>%
        rename( lower_95 = 4, upper_95 = 5 )
    res_coef %>%
        left_join( res_conf, by = "predictor" ) %>%
        select( predictor, coef, HR, pvalue, lower_95, upper_95 ) %>%
        gather( type, value, -predictor ) %>%
        mutate( value = signif( value, 4 ) ) %>%
        spread( type, value ) %>%
        select( predictor, coef, HR, pvalue, lower_95, upper_95 )
}

format_coxph( coxph_fit_OS_rasact_tcga, factor_name = "RAS84" ) %>%
    mutate( RSG_test_n = RSG_OS_n[ -1 ], RSG_control_n = RSG_OS_n[ 1 ] ) %>%
    datatable( rownames = FALSE )
```

### OS Kaplan-Meiers {.tabset .tabset-fade}

```{r km_OS_rasact_tcga,results='asis',echo=FALSE}
cat( "#### All RAS activity groups\n" )
fit <- survfit( Surv( OS.Time, OS ) ~ RAS84, colData( se_t ) )
gg <- ggsurvplot( fit, data = colData( se_t ), pval = TRUE )
print( gg ) 
cat ( " \n\n" )
for( i in levels(  se_t$RAS84 )[ -1 ] ) {
    cat( "#### ", i, "\n" )
    f <- se_t$RAS84 %in% c( "RSG_0", i )
    fit <- survfit( Surv( OS.Time/365*12, OS ) ~ RAS84, colData( se_t )[ f, ] )
    gg <- ggsurvplot( fit, data = colData( se_t )[ f, ],
                     palette = c( my_blue, my_red ), pval = TRUE )
    print( gg )
    cairo_pdf( file = file.path( adat$plot.path, paste0( i, "_RGS-0_OS_TCGA_KM.pdf" ) ),
              width = 4, height = 4 )
    print( gg )
    dev.off()
    cat( " \n\n" )
}
```

### PFS Results table

```{r table_PFS_coxph_rasact_tcga}
format_coxph( coxph_fit_PFS_rasact_tcga, factor_name = "RAS84" ) %>%
    mutate( RSG_test_n = RSG_OS_n[ -1 ], RSG_control_n = RSG_OS_n[ 1 ] ) %>%
    datatable( rownames = FALSE )
```

### PFS Kaplan-Meiers {.tabset .tabset-fade}

```{r km_PFS_rasact_tcga,results='asis',echo=FALSE}
cat( "#### All RAS activity groups\n" )
fit <- survfit( Surv( PFS_time, PFS ) ~ RAS84, colData( se_t ) )
gg <- ggsurvplot( fit, data = colData( se_t ), pval = TRUE )
print( gg ) 
cat ( " \n\n" )
for( i in levels(  se_t$RAS84 )[ -1 ] ) {
    cat( "#### ", i, "\n" )
    f <- se_t$RAS84 %in% c( "RSG_0", i )
    fit <- survfit( Surv( PFS_time/365*12, PFS ) ~ RAS84, colData( se_t )[ f, ] )
    gg <- ggsurvplot( fit, data = colData( se_t )[ f, ],
                     palette = c( my_blue, my_red ), pval = TRUE )
    print( gg )
    cairo_pdf( file = file.path( adat$plot.path, paste0( i, "_RGS-0_PFS_TCGA_KM.pdf" ) ),
              width = 4, height = 4 )
    print( gg )
    dev.off()
    cat( " \n\n" )
}
```

## RAS index coxph analysis

Here we fit a univariate cox proportional hazard regression model to
the RSI, a continuous variable measuring tumour RAS
pathway activity. We found a significant positive association with
outcome, showing increased RAS84 activity is a predictor of poor
outcome. To visualise the ability of RSI to predict survival we
used the model to predict survival time given a two-fold increase or
decrease in RSI. These predictions are shown in the KM plot below
(high RSI in red, low in blue).

```{r coxph_rasindex_tcga}
coxph_fit_OS_rasindex_tcga <- coxph( Surv( OS.Time/365*12, OS ) ~ ras_index, colData( se_t ) )
coxph_fit_PFS_rasindex_tcga <- coxph( Surv( PFS_time/365*12, PFS ) ~ ras_index, colData( se_t ) )
```

### OS Results table

```{r table_coxph_OS_rasindex_tcga}
format_coxph( coxph_fit_OS_rasindex_tcga ) %>%
    datatable( rownames = FALSE )
```

### OS Kaplan Meier

```{r km_OS_rasindex_tcga,results='hide'}
surv_l <- list( mid = survfit( coxph_fit_OS_rasindex_tcga,
                              newdata = data.frame( ras_index = mean( se_t$ras_index) ),
                              data = as.data.frame( colData( se_t ) ) ),
               upper = survfit( coxph_fit_OS_rasindex_tcga,
                               newdata = data.frame( ras_index = mean( se_t$ras_index ) + 1 ),
                               data = as.data.frame( colData( se_t ) ) ),
               lower = survfit( coxph_fit_OS_rasindex_tcga,
                               newdata = data.frame( ras_index = mean( se_t$ras_index ) - 1 ),
                               data = as.data.frame( colData( se_t ) ) ) )
gg <- ggsurvplot( surv_l,
                 combine = TRUE,
                 palette = c( my_grey, my_red, my_blue ) )
print( gg )
cairo_pdf( file = file.path( adat$plot.path, "ras_index_OS_TCGA_KM.pdf" ),
          width = 4, height = 4 )
print( gg )
dev.off( )
```

## RAS index ~ KRAS mutation coxph analysis

Here we split the patients into high.medium,low and KRAS mutation +-
and run a univariate coxph analysis.

```{r km_OS_rasindex_krasmut_tcga}
colData( se_t )$ri_kras <- paste( cut( se_t$ras_index,
                                      breaks = 3,
                                      labels = c( "low", "med", "high" ) ),
                                 se_t$MUT.KRAS, sep = "_" )
colData( se_t )$rasindex_krasmut <- factor( colData( se_t )$rasindex_krasmut )

## vs low_FALSE
colData( se_t )$rasindex_krasmut <- relevel( colData( se_t )$rasindex_krasmut, "low_FALSE" )
coxph_fit_OS_rasindex_krasmut_tcga <- coxph( Surv( OS.Time, OS ) ~ rasindex_krasmut, colData( se_t ) )

## vs low_TRUE
colData( se_t )$rasindex_krasmut <- relevel( colData( se_t )$rasindex_krasmut, "low_TRUE" )
coxph_fit_OS_rasindex_krasmut_tcga <- coxph( Surv( OS.Time, OS ) ~ rasindex_krasmut, colData( se_t ) )

## vs high_FALSE
colData( se_t )$rasindex_krasmut <- relevel( colData( se_t )$rasindex_krasmut, "high_FALSE" )
coxph_fit_OS_rasindex_krasmut_tcga <- coxph( Surv( OS.Time, OS ) ~ rasindex_krasmut, colData( se_t ) )


fit <- survfit( Surv( OS.Time/365*12, OS ) ~ ri_kras, colData( se_t ) )
gg <- ggsurvplot( fit, data = colData( se_t ), pval = TRUE )

cairo_pdf( file = file.path( adat$plot.path, "ras_index_krasmut_OS_TCGA_KM.pdf" ),
           width = 5, height = 5 )
print( gg )
dev.off( )
```

## KRAS mutation

We show no association in a Coxph analysis between KRAS mutation status and overall
survival.

```{r kras}
coxph_fit_krasmut_tcga <- coxph( Surv( OS.Time/365*12, OS ) ~ MUT.KRAS, colData( se_t ) )
```

### Results table

```{r table_coxph_krasmut_tcga}
krasmut_OS_n <- table( se_t$MUT.KRAS )
format_coxph( coxph_fit_krasmut_tcga ) %>%
    mutate( KRAS_mutant = krasmut_OS_n[ 2 ], KRAS_wildtype = krasmut_OS_n[ 1 ] ) %>%
    datatable( rownames = FALSE )
```

### Kaplan Meier

```{r km_coxph_krasmut_tcga,results='hide'}
fit <- survfit( Surv( OS.Time/365*12, OS ) ~ MUT.KRAS, colData( se_t ) )
gg <- ggsurvplot( fit, data = colData( se_t ), pval = TRUE,
                 palette = c( my_red, "black" ) )
print( gg )
cairo_pdf( file = file.path( adat$plot.path, "kras_mut_KM.pdf" ),
              width = 4, height = 4 )
print( gg )
dev.off()
```

## Small signature

### Clustering

```{r small_sig_clustering_multivariate}
cluster_no <- 5
RF_genes_ranked <- read.table( file = file.path( "..", "RAS_short_signature", "TCGA", "LUAD", "RF_ranked_RAS84_genes.txt" ), sep = "\t", header = TRUE, stringsAsFactors = FALSE )

small_sigs_RF_ranked <- map( 6:nrow( RF_genes_ranked ), function( i ) {
    RF_genes_ranked$genes[ 1:i ]
} )
names( small_sigs_RF_ranked ) <- as.character( 6:nrow( RF_genes_ranked ) )

samp_clust_l <- lapply( small_sigs_RF_ranked, function( sig_genes ) {
    sig_f <- rowData( se_t )$gene_symbol %in% sig_genes
    vst_mat <- assays( se_t )$vst[ sig_f, ]
    hc <- hclust( dist( t( vst_mat ) ), method = "ward.D2" )
    ct_df <- cutree( hc, k = cluster_no ) %>%
        as.data.frame( ) %>%
        dplyr::rename( ct_cluster = 1 ) %>%
        rownames_to_column( var = "barcode" )
    ct_means <- vst_mat %>%
        as.data.frame( ) %>%
        tidyr::gather( barcode, value ) %>%
        left_join( ct_df, by = "barcode" ) %>%
        group_by( ct_cluster ) %>%
        dplyr::summarize( mean = mean( value ) ) %>%
        arrange( mean ) %>%
        mutate( RAG_5 = paste( "RAG", 0:( cluster_no - 1 ), sep = "-" ) )
    ct_df %>%
        left_join( ct_means, by = "ct_cluster" ) %>%
        mutate( RAG_5 = factor( RAG_5 ) ) %>%
        dplyr::select( barcode, RAG_5 )
} )

RAG_coxph_univ_l <- map( samp_clust_l, function( RAG_df ) {
    RAG_vec <- RAG_df$RAG_5
    OS_dat <- colData( se_t ) %>%
        as.data.frame( ) %>%
        left_join( RAG_df, by = "barcode" )
    coxph( Surv( OS.Time, OS ) ~ RAG_5, OS_dat )
} )

RAG_coxph_univ_df <- map( RAG_coxph_univ_l, format_coxph, factor_name = "RAG_5" ) %>%
    bind_rows( .id = "RF_rank" ) %>%
    dplyr::filter( predictor == "RAG-4" ) %>%
    mutate( RF_rank = as.numeric( RF_rank ) ) %>%
    mutate( fdr = p.adjust( pvalue, method = "fdr" ) ) %>%
    mutate( sig_label = fdr < 0.05 ) 

RAG_coxph_univ_df %>%
    filter( pvalue < 0.05 )

RAG_coxph_univ_df %>%
    write.table( file = file.path( adat$analysis.path, "RAG4_coxph_univ_small_sig_res_TCGA.txt" ),
                 row.names = FALSE, quote = FALSE )

small_sig_coxph_gg <- RAG_coxph_univ_df %>%
    ggplot( aes( x = RF_rank, y = HR ) ) +
    geom_line( ) +
    geom_point( size = 3, aes( color = sig_label ) ) +
    scale_colour_manual( values = c( "grey", "orange" ) ) +
    scale_linetype_manual( values = c( "solid", "dotted", "dotted" ) ) +
    labs( x = "Signature gene count", y = "Hazard Ratio", color = "significant",
         title = "RAG-4 univariate coxph TCGA" ) +
    plot_formatter( )

cairo_pdf( file = file.path( adat$plot.path, "small_sig_univar_coxph_TCGA_v2.pdf" ),
          width = 6, height = 3 )
print( small_sig_coxph_gg )
dev.off( )

KM_df <- colData( se_t ) %>%
    as.data.frame( ) %>%
    mutate( RAG = samp_clust_l$'55'$RAG_5 ) %>%
    filter( !is.na( OS.Time ) ) %>%
    filter( !is.na( OS ) ) %>%
    filter( RAG %in% c( "RAG-0", "RAG-4" ) )

fit <- survfit( Surv( OS.Time/365*12, OS ) ~ RAG, KM_df )
gg <- ggsurvplot( fit, data = KM_df, pval = TRUE )
##                 palette = c( my_red, "black" ) )

cairo_pdf( file = file.path( adat$plot.path, "RAG_short_55_KM_TCGA.pdf" ),
              width = 4, height = 4 )
print( gg )
dev.off()
```

## SVM

```{r smv_classification}
feature_id_map_file <- file.path( "..", "..", "data", "signatures", "ras", "RAS84_feature_map.xlsx" )
feature_id_map <- read.xlsx( feature_id_map_file )
feature_id_map <- feature_id_map %>%
    left_join( as.data.frame( rowData( se_t ) )[ c( "id", "gene_id" ) ],
              by = c( "TCGA_feature_id" = "id" ) )
RF_rank_models_l <- readRDS( file = file.path( "..", "classifiers", "RF_ranked_svm_models_l.rds" ) )

RAG_classes <- map( RF_rank_models_l, function( m ) {
    mat <- assays( se_t )$z %>%
                        as.data.frame( ) %>%
                        rownames_to_column( var = "TCGA_feature_id" ) %>%
                        left_join( feature_id_map[, c( "TCGA_feature_id", "svm" ) ], by = "TCGA_feature_id" ) %>%
                        filter( svm %in% predictors( m ) ) %>%
                        dplyr::select( -TCGA_feature_id ) %>%
                        column_to_rownames( var = "svm" ) %>%
                        as.matrix( )
    rag_5 <- predict( m, t( mat ) )
    data.frame( barcode = se_t$barcode, 
                RAG_5 = factor( rag_5, levels = c( "RAG-0", "RAG-1", "RAG-2", "RAG-3", "RAG-4" ) ) )
} )

RAG_coxph_univ_l <- map( RAG_classes, function( RAG_df ) {
    RAG_vec <- RAG_df$RAG_5
    OS_dat <- colData( se_t ) %>%
        as.data.frame( ) %>%
        left_join( RAG_df, by = "barcode" )
    coxph( Surv( OS.Time, OS ) ~ RAG_5, OS_dat )
} )

RAG_coxph_univ_df <- map( RAG_coxph_univ_l, format_coxph, factor_name = "RAG_5" ) %>%
    bind_rows( .id = "RF_rank" ) %>%
    dplyr::filter( predictor == "RAG-4" ) %>%
    mutate( RF_rank = as.numeric( RF_rank ) ) %>%
    mutate( fdr = p.adjust( pvalue, method = "fdr" ) ) %>%
    mutate( sig_label = fdr < 0.05 ) 

RAG_coxph_univ_df %>%
    filter( RF_rank ==  "55" )

RAG_coxph_univ_df %>%
    write.table( file = file.path( adat$analysis.path, "RAG4_coxph_univ_small_sig_res_TCGA.txt" ),
                row.names = FALSE, quote = FALSE )

KM_df <- colData( se_t ) %>%
    as.data.frame( ) %>%
    mutate( RAG = RAG_classes$'55'$RAG_5 ) %>%
    filter( !is.na( OS.Time ) ) %>%
    filter( !is.na( OS ) ) %>%
    filter( RAG %in% c( "RAG-0", "RAG-4" ) )

fit <- survfit( Surv( OS.Time/365*12, OS ) ~ RAG, KM_df )
gg <- ggsurvplot( fit, data = KM_df, pval = TRUE )
##                 palette = c( my_red, "black" ) )

cairo_pdf( file = file.path( adat$plot.path, "RAG_short_55_KM_TCGA_SVM.pdf" ),
              width = 4, height = 4 )
print( gg )
dev.off()
```

## Parent signatures

Here we run a survival analysis against the RSGs derived from other
RAS signatures used to derive RAS84 which was used to drive the RSGs
and RSI usng here.

```{r survival_parent_sigs}
parent_sigs <- c( "Bild.Nevins", "KRAS_msigdb_HM",
                  "Loboda", "SweetCordero", "RAS84" )

uvsur_res_l <- map( parent_sigs, function( s ) {
    coxph( as.formula( paste( "Surv( OS.Time, OS ) ~",  s ) ), colData( se_t ) )
} ) %>%
    map( format_coxph )
names( uvsur_res_l ) <- parent_sigs

results <- list( uvsurv_RSG_TCGA = uvsur_res_l %>%
                     bind_rows( .id = "signature" ) %>%
                     select( signature, predictor, HR, lower_95, upper_95, pvalue ) %>%
                     mutate( signature = factor( signature, levels = c( "RAS84", parent_sigs[ -5 ] ) ) ) %>%
                     mutate( predictor = sub( ".*RAG", "RAG", predictor ) ) )

plotdat <- results$uvsurv_RSG_TCGA
uvsurv_gg <- ggplot( plotdat,
                    aes( x = HR, y = -log10( pvalue ), color = signature, label = predictor ) ) +
    geom_point( size = 2 ) +
    geom_point( data = subset( plotdat, signature == "RAS84" ),
               aes( x = HR, y = -log10( pvalue ) ),
               size = 3 ) +
    geom_text_repel( data = subset( plotdat, pvalue < 0.05 ),
                    aes( x = HR, y = -log10( pvalue ), label = predictor ) ) +
    geom_hline( yintercept = -log10( 0.05 ), color = my_orange, linetype = "dashed" ) +
    plot_formatter( )

print( mv_surv_gg )
cairo_pdf( file = file.path( adat$plot.path, "uvcox_parent_sigs_volcano.pdf" ),
           width = 5, height = 4 )
print( uvsurv_gg )
dev.off( )
```

## Nagy et. al. 5 gene RAS signature

Here we test the five gene RAS prognostic signature publised by [Nagy
et al]
(https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5299512/pdf/IJC-140-930.pdf).

```{r nagy}
genes_nagy <- c( "FOXRED2", "KRAS", "TOP1", "PEX3", "ABL2" )

sig_exprs <- assays( se_t )$vst %>%
                          as.data.frame( ) %>%
                          rownames_to_column( var = "id" ) %>%
                          mutate( gene_id = sub( "\\|.*" , "" , id ) ) %>%
                          filter( gene_id %in% genes_nagy ) %>%
                          gather( sample_id, value, -id, -gene_id ) %>%
                          group_by( sample_id ) %>%
                          dplyr::summarize( nagy = mean( value ) ) %>%
                          left_join( as.data.frame( colData( se_t )[, c( "rowname", "OS", "OS.Time" ) ] ),
                                    by = c( "sample_id" = "rowname" ) ) %>%
                          mutate( nagy_high = as.factor( nagy > median( nagy ) ) )

nagy_coxph <- coxph( Surv( OS.Time/365*12, OS ) ~ nagy_high, sig_exprs )

fit <- survfit(  Surv( OS.Time/365*12, OS ) ~ nagy_high, sig_exprs )
gg <- ggsurvplot( fit, data = sig_exprs, pval = TRUE,
                 palette = c( my_blue, my_red ),
                 xlab = "Time / months" )
print( gg )
cairo_pdf( file = file.path( adat$plot.path, "nagy_LUAD_TCGA.pdf" ),
              width = 5, height = 4 )
print( gg )
dev.off()
```

# Uppsala cohort


[GSE81089](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE81089)
 
Fresh frozen tumor tissue from 199 patients diagnosed with NSCLC and surgically treated 2006-2010 at the Uppsala University Hospital, Uppsala, Sweden and 19 paired normal lung tissues. Clinical data were retrieved from the regional lung cancer registry

First we load signature gene lists so we can classify the Uppsala data.

```{r signatures}
SIG_HOME <- file.path( "..", "..", "data", "signatures", "ras", "active" )
signatures_raw <- init.signatures()

load( file = file.path( "..", "..", "analysis", "validate_signatures", "CCLE", "LUNG", "signatures_filtered.rda" ) )

signatures_raw$RAS84 <- signatures$RAS84
```

Here we read in the Uppsala expression and clinical data and create a
SummarizedExperiment object. Annotation is obtained form BioMart.

```{r uppsala,fig.width=4,fig.height=3}
uppsala_file <- file.path( adat$analysis.path, "se_GSE81089.rds" )
if( file.exists( uppsala_file ) ) {
    se_uppsala <- readRDS( uppsala_file )
} else {
    library("biomaRt")
    ensembl <- useMart( "ensembl", dataset="hsapiens_gene_ensembl" )
    gse <- getGEO( 'GSE81089',
                  destdir = adat$analysis.path,
                  GSEMatrix = TRUE )
    eset <- gse[[ 1 ]]
    ## remove normals
    eset <- eset[, pData( eset )$source_name_ch1 == "Human NSCLC tissue" ]
    exprs_dat <- read.delim( file = file.path( "validation_data", "uppsala", "GSE81089_readcounts_featurecounts.tsv" ),
                             row.names = 1 )
    ## two sample ids do not match between expression matrix and pData(eset)$title
    ## We remove those here.
    common_sample_ids <- intersect( sampleNames( eset ), colnames( exprs_dat ) )
    eset <- eset[, common_sample_ids ]
    exprs_mat <- as.matrix( exprs_dat[, common_sample_ids ] )
    ensembl_dat <- getBM( attributes = c( "ensembl_gene_id", "external_gene_name" ),
                         filters = "ensembl_gene_id",
                         values = rownames( exprs_mat ),
                         mart = ensembl )
    rowdat <- data.frame( ensembl_gene_id = rownames( exprs_mat ) ) %>%
        left_join( ensembl_dat, by = "ensembl_gene_id" ) %>%
        mutate( rownames = ensembl_gene_id ) %>%
        column_to_rownames( var = "rownames" )
    se <- SummarizedExperiment( assay = exprs_mat,
                               colData = pData( eset ),
                               rowData = rowdat )
    se <- se[ !is.na( rowData( se )$external_gene_name ), ]
    assays( se )$vst <- DESeq2::vst( assay( se ) )
    assays( se )$z <- t( scale( t( scale( assays( se )$vst ) ) ) )
    saveRDS( se, file = file.path( adat$analysis.path, "se_GSE81089.rds" ) )
}

se_uppsala
hist( assays( se_uppsala )$vst, main = "Expression distribution all features" )
```

## Survival data

We run univariate and multivariate coxph proportional hazard analysis against RSGs and
RSI values. The multivariate details are explained below. 

We first clean up the clinical data column headers and labels.

Stage according to pTNM: 1=1a 2=1b 3=2a 4=2b 5=3a 6=3b 7=IV
Smoking history : 1=current 2=ex >1year 3=never

We calculate the overall survival time as the differene between the
data of surgery and the reported vital date.

```{r survival_data_uppsala}
surv_time <- difftime( strptime( se_uppsala$'vital date:ch1',
                                 format = "%Y-%m-%d"),
                       strptime( se_uppsala$'surgery date:ch1',
                                format = "%Y-%m-%d"), units = "weeks" )
pdat <- colData( se_uppsala ) %>%
    as.data.frame( )
stage_map <- c( "I", "I", "II", "II", "III", "III", "IV" )
smoking_map <- c( "current", "ex >1year", "never" )
colData( se_uppsala ) <- pdat %>%
    mutate( OS = as.numeric( pdat$'dead.ch1' ) ) %>%
    mutate( OS_time = surv_time )%>%
    mutate( age = as.numeric( pdat$'age.ch1' ) ) %>%
    mutate( sex = pdat$'gender.ch1' ) %>%
    mutate( stage = stage_map[ as.numeric( pdat$'stage.tnm.ch1' ) ] ) %>%
    mutate( ps.who = as.character( pdat$ps.who.ch1 ) ) %>%
    mutate( smoking = factor( smoking_map[ as.numeric( pdat$smoking.ch1 ) ],
                             levels = smoking_map[ 3:1 ] ) ) %>%
    DataFrame( row.names = .$title )
se_uppsala <- se_uppsala[ , se_uppsala$stage != "IV" ]
#write.xlsx( colData( se_uppsala )[, c( "OS", "OS_time", "RAS84", "ras_index", "age", "sex", "stage", "ps.who", "smoki#ng" ) ],
#           file.path( adat$analysis.path, "Uppsala_GSE81089_survival_data.xlsx") )
```

## Histology

This is a mixed histology cohort. We are only interested in the
andenocarcinomas. Here we select these tumours. Column `se_uppsala$histology:ch1 == 2`. 

(1=squamous cell cancer 2=AC unspecified 3=Large cell/ NOS)

```{r filter_luad_uppsala,fig.width=4,fig.height=3}
hist_label <- c( "squamous", "LUAD", "Large cell" ) 
histology_gg <- colData( se_uppsala ) %>%
    as.data.frame( ) %>%
    mutate( histology_label = hist_label[ as.numeric( se_uppsala$'histology.ch1' ) ] ) %>%
    ggplot( aes( x = histology_label, fill = histology_label ) ) +
    geom_bar( position = "dodge" ) +
    theme( axis.text.x = element_text( angle = 90, hjust = 1 ) )
print( histology_gg )
se_uppsala <- se_uppsala[, se_uppsala$'histology.ch1' == 2 ]
se_uppsala
```

## Correct gene symbol mappings for RAS84

There are mapping issues with four genes when mapping the Uppsala
annotation to RAS84. 

* Uppsala -> RAS84
--------------------
* RESF1 -> C12orf35
* FAM241A -> C4orf32
* CXCL8 -> IL8
* ITPRID2 -> SSFA2

We change the Uppsala annotation to make it compatible with RAS84.

IER3 maps to multiple features in the Uppsala annotation. We select
ENSG00000137331 as the primary feature for IER3.

```{r ras84_uppsala}
se_uppsala_ras84 <- se_uppsala[ RAS84_idmap$Uppsala_feature_ids, ]
rowData( se_uppsala_ras84 ) <- rowData( se_uppsala_ras84 ) %>%
    as.data.frame( ) %>%
    left_join( RAS84_idmap[, c( "Uppsala_feature_ids", "TCGA_gene_symbol", "svm" ) ], by = c( "ensembl_gene_id" = "Uppsala_feature_ids" ) )

signatures_ensembl <- map( signatures_raw, function( sig ) {
    rowData( se_uppsala ) %>%
        as.data.frame( ) %>%
        filter( external_gene_name %in% sig ) %>%
        pull( ensembl_gene_id )
} )
signatures_ensembl$RAS84 <- RAS84_idmap$Uppsala_feature_ids
```

## CoxphMIC

```{r coxphmic_uppsala}
surv_dat <- colData( se_uppsala_ras84 ) %>%
    as.data.frame( ) %>%
    dplyr::select( title, OS, OS_time )

exprs_dat <- assays( se_uppsala_ras84 )$vst %>%
    as.data.frame( ) %>%
    rownames_to_column( var = "Uppsala_feature_ids" ) %>%
    left_join( RAS84_idmap[, c( "Uppsala_feature_ids", "TCGA_gene_symbol" ) ], by = "Uppsala_feature_ids" ) %>%
    dplyr::select( -Uppsala_feature_ids ) %>%
    gather( title, value, -TCGA_gene_symbol ) %>%
    spread( TCGA_gene_symbol, value )

surv_dat <- surv_dat %>%
    left_join( exprs_dat, by = "title", suffix = c( "", "" ) ) %>%
    filter( !is.na( OS_time ) )

fit.mic <- coxphMIC( formula = Surv( OS_time, OS )~.-title, data = surv_dat, method = "BIC" )

cairo_pdf( file = file.path( adat$plot.path, "coxphMIC_plot_uppsala.pdf" ),
          width = 5, height = 3 )
print( plot( fit.mic ) )
dev.off( )

coxphMIC_genes <- fit.mic$result %>%
    as.data.frame( ) %>%
    rownames_to_column( var = "gene_symbols" ) %>%
    filter( p.value < 0.05 ) %>%
    pull( gene_symbols )
```

## Clusters

We cluster the tumours into five groups using the VST expression
data across the RAS84 and published RAS expression signatures. We also
calculate a per-patient RSI value for RAS84.

```{r clustering_uppsala}
RSG_labels <- c( "RSG-0", "RSG-1", "RSG-2", "RSG-3", "RSG-4" )
cluster_no <- 5
RSG_l <- lapply( signatures_ensembl, function( sig_genes ) {
    sig_f <- rowData( se_uppsala )$ensembl_gene_id %in% sig_genes
    se_local <- se_uppsala[ sig_f, ]
    hc <- hclust( dist( t( assays( se_local )$vst ) ), method = "ward.D2" )
    ct <- cutree( hc, k = cluster_no )
    ct_df <- data.frame( cluster = ct, title = names( ct ) )
    ct_means <- assays( se_local )$vst %>%
                                 as.data.frame( ) %>%
                                 gather( title, value ) %>%
                                 left_join( ct_df, by = "title" ) %>%
                                 group_by( cluster ) %>%
                                 dplyr::summarize( ct_mean = mean( value ) ) %>%
                                 arrange( ct_mean ) %>%
                                 mutate( RSG = factor( RSG_labels, levels = RSG_labels ) )
    ct_df %>%
        left_join( ct_means, by = "cluster" ) %>%
        select( title, RSG )
} )

RSG_df <- map( RSG_l, function( x ) x$RSG ) %>%
    bind_cols( ) %>%
    as.data.frame( )
RSG_df$title <- RSG_l[[ 1 ]]$title

colData( se_uppsala ) <- colData( se_uppsala ) %>%
    as.data.frame( ) %>%
    left_join( RSG_df, by = "title" ) %>%
    DataFrame( row.names = .$title )

ras84_sig_f <- rowData( se_uppsala )$ensembl_gene_id %in% signatures_ensembl$RAS84
se_uppsala$ras_index <- colMeans( assays( se_uppsala )$vst[ ras84_sig_f, ] )
```

### Heatmap

Heatmap showing the clustering of the Uppsala patients using RAS84.

```{r heatmap_uppsala,fig.width=12,fig.height=8}
se_uppsala_ras84 <- se_uppsala[ ras84_sig_f, ]
hmcols <- colorpanel( 1000, "#4066AA", "white", "#E3001A" )
hmmat <- assays( se_uppsala_ras84 )$vst - rowMedians( assays( se_uppsala_ras84 )$vst )

hmmat_gs <- hmmat %>%
    as.data.frame( ) %>%
    rownames_to_column( var = "ensembl_gene_id" ) %>%
    left_join( as.data.frame( rowData( se_uppsala ) ), by = "ensembl_gene_id" ) %>%
    dplyr::select( -ensembl_gene_id ) %>%
    column_to_rownames( var = "external_gene_name" ) %>%
    as.matrix( )

hm <- Heatmap( t( hmmat_gs ),
              name = "Expression", 
              clustering_method_rows = "ward.D2",
              clustering_method_columns = "ward.D2",
              show_column_names = TRUE,
              show_row_names = FALSE,
              col = colorRamp2(
                  seq( from = -3, to = 3, length.out = length( hmcols ) ),
                  hmcols ),
              row_split = se_uppsala$RAS84,
              row_gap = unit( 1, "mm" ),
              column_title = "RAS84 in Uppsala",
              column_title_gp = gpar( fontsize = 14 ),
              column_names_gp = gpar( fontsize = 8 ),
              show_heatmap_legend = FALSE,
              cluster_row_slices = FALSE,
              row_names_max_width = unit( 10, "mm" ) )
print( hm )
```

```{r class_sig_overlap_heatmap}
hm_dat <- RSG_df %>%
    dplyr::select( -Singh_Settleman ) %>%
    relocate( RAS84, .before = 1 ) %>%
    relocate( Loboda, .before = 3 )
    
hm <- Heatmap( hm_dat,
              name = "Overlap", 
              clustering_method_rows = "ward.D2",
              #clustering_method_columns = "ward.D2",
              show_column_names = TRUE,
              col = c( "grey" , "darkgreen", "purple", "orange", "black" ),
              #colorRamp2(
              #    seq( from = -2, to = 2, length.out = length( hmcols ) ),
              #    hmcols ),
              row_split = hm_dat$RAS84,
              column_split = factor( colnames( hm_dat ), levels = colnames( hm_dat ) ),
              column_title = sig_n,
              column_title_gp = gpar( fontsize = 14 ),
              column_names_gp = gpar( fontsize = 12 ),
              heatmap_legend_param = list( title_gp = gpar( fontsize = 14 ),
                                          labels_gp = gpar( fontsize = 12 ) ),
              show_heatmap_legend = TRUE,
              #cluster_row_slices = FALSE,
              row_names_max_width = unit( 10, "mm" ) )
png( file = "test_hm.png", width = 300 )
print( hm )
dev.off( )

cairo_pdf( file = file.path( adat$plot.path, "signature_class_overlap.pdf" ),
          width = 4 )
print( hm )
dev.off( )
```


## RAS activity coxph analysis

Here we build the coxph model using overall survival data and RSGs
dervied from RAS84.

```{r rasact_OS_uppsala}
RSG_uppsala_n <- table( se_uppsala$RAS84 )
coxph_fit_rasact_uppsala <- coxph( Surv( OS_time, OS ) ~ RAS84, colData( se_uppsala ) )
```

### Results table

```{r table_rasact_uppsala}
format_coxph( coxph_fit_rasact_uppsala, factor_name = "RAS84" ) %>%
    mutate( RSG_test_n = RSG_uppsala_n[ -1 ], RSG_control_n = RSG_uppsala_n[ 1 ] ) %>%
    datatable( )
```

### Kaplan-Meiers {.tabset .tabset-fade}

```{r km_rasact_uppsala,results='asis',echo=FALSE}
cat( "#### All RAS actvity groups\n" )
fit <- survfit( Surv( OS_time/52*12, OS ) ~ RAS84, colData( se_uppsala ) )
gg <- ggsurvplot( fit, data = colData( se_uppsala ), pval = TRUE )
print( gg ) 
cat ( " \n\n" )
for( i in levels( se_uppsala$RAS84 )[ -1 ] ) {
    cat( "#### ", i, "\n" )
    f <- se_uppsala$RAS84 %in% c( "RSG-0", i )
    fit <- survfit( Surv( OS_time/52*12, OS ) ~ RAS84, colData( se_uppsala )[ f, ] )
    gg <- ggsurvplot( fit, data = colData( se_uppsala )[ f, ], pval = TRUE,
                     palette = c( my_blue, my_red ) )
    print( gg )
    cairo_pdf( file = file.path( adat$plot.path, paste0( i, "_RSG-0_UV_uppsala_KM.pdf" ) ),
              width = 4, height = 4 )
    print( gg )
    dev.off()
    cat( " \n\n" )
}
```

## RAS index coxph analysis

Here we fit a univariate cox proportional hazard regression model to
the RSI, a continuous variable measuring tumour RAS
pathway activity. We found a significant positive association with
outcome, showing increased RAS84 activity is a predictor of poor
outcome. To visualise the ability of RSI to predict survival we
used the model to predict survival time given a two-fold increase or
decrease in RSI. These predictions are shown in the KM plot below
(high RSI in red, low in blue).

```{r rasindex_OS_uppsala}
coxph_fit_rasindex_uppsala <- coxph( Surv( OS_time/52*12, OS ) ~ ras_index, colData( se_uppsala ) )
```

### Results table

```{r table_rasindex_uppsala}
format_coxph( coxph_fit_rasindex_uppsala ) %>%
    datatable( rownames = FALSE )
```

### Kaplan-Meier

```{r km_rasindex_uppsala}
surv_l <- list( mid = survfit( coxph_fit_rasindex_uppsala,
                              newdata = data.frame( ras_index = mean( se_uppsala$ras_index) ),
                              data = as.data.frame( colData( se_uppsala ) ) ),
               upper = survfit( coxph_fit_rasindex_uppsala,
                               newdata = data.frame( ras_index = mean( se_uppsala$ras_index ) + 1 ),
                               data = as.data.frame( colData( se_uppsala ) ) ),
               lower = survfit( coxph_fit_rasindex_uppsala,
                               newdata = data.frame( ras_index = mean( se_uppsala$ras_index ) - 1 ),
                               data = as.data.frame( colData( se_uppsala ) ) ) )
gg <- ggsurvplot( surv_l,
                 combine = TRUE,
                 palette = c( my_grey, my_red, my_blue ) )
print( gg )
```
```{r render_km_rasindex_uppsala,echo=FALSE,results='hide'}
cairo_pdf( file = file.path( adat$plot.path, "ras_index_uppsalas_KM.pdf" ),
          width = 4, height = 4 )
print( gg )
dev.off( )
```

## All signatures

Here we run a univariate survival analysis against the RSGs derived from the
parent signatures.

```{r uv_uppsala_parent_sigs}
parent_sigs <- c( "Bild.Nevins", "Downward_134", "KRAS_msigdb_HM",
                  "Loboda", "SweetCordero", "RAS84" )

uvsur_uppsala_res_l <- map( parent_sigs, function( s ) {
    coxph_fit_rasact <- coxph( as.formula( paste( "Surv( OS_time, OS ) ~",  s ) ), colData( se_uppsala ) )
    format_coxph( coxph_fit_rasact, factor_name = s )
} )
names( uvsur_uppsala_res_l ) <- parent_sigs

results$uvsurv_RSG_uppsala <- uvsur_uppsala_res_l %>%
    bind_rows( .id = "signature" ) %>%
    select( signature, predictor, HR, lower_95, upper_95, pvalue )

datatable( results$uvsurv_RSG_uppsala, rownames = FALSE )
```

## Multivariate survival analysis

Here we carry out a multivariate survival analysis using the Uppsala
cohort. This determines the ability of the RSGs and RSI
to predict outcome beyond known clincail predictors of
outcome. We test tumour stage, WHO performace score, smoking status,
sex and age alongside RSG and RSI.

### RAS activity coxph

```{r multivariate_rasact}
coxph_mv_form_bg <- as.formula( "Surv( OS_time/52*12, OS ) ~ rcs( age, 3 ) + smoking + sex + stage + ps.who" )
coxph_mv_fit_bg <- coxph( coxph_mv_form_bg, colData( se_uppsala ) )

coxph_mv_form_rasact <- as.formula( "Surv( OS_time/52*12, OS ) ~ rcs( age, 3 ) + sex + stage + ps.who + smoking + RAS84" )

coxph_mv_fit_rasact <- coxph( coxph_mv_form_rasact, colData( se_uppsala ) )

anova_res <- anova( coxph_mv_fit_rasact, coxph_mv_fit_bg )

coxph_mv_form_rasact_forest <- as.formula( "Surv( OS_time/52*12, OS ) ~ sex + stage + ps.who + smoking + RAS84" )
coxph_mv_fit_rasact_forest <- coxph( coxph_mv_form_rasact_forest, colData( se_uppsala ) )
res_mvar_rasact <- format_coxph( coxph_mv_fit_rasact_forest, factor_name = "RAS84" )
datatable( res_mvar_rasact, rownames = FALSE )
```

### RAS index coxph

```{r multivariate_rasindex}
coxph_mv_fit_rasindex <- coxph( Surv( OS_time, OS ) ~ rcs( age, 3 ) + sex + stage + ps.who + smoking + ras_index, colData( se_uppsala ) )
res_mvar_rasindex <- format_coxph( coxph_mv_fit_rasindex )
datatable( res_mvar_rasindex,  rownames = FALSE )
```

### RAS activity & index coxph

```{r multivariate_rasact}
coxph_mv_form_bg <- as.formula( "Surv( OS_time/52*12, OS ) ~ rcs( age, 3 ) + smoking + sex + stage + ps.who" )
coxph_mv_fit_bg <- coxph( coxph_mv_form_bg, colData( se_uppsala ) )

coxph_mv_form_ri_rasact <- as.formula( "Surv( OS_time/52*12, OS ) ~ rcs( age, 3 ) + sex + stage + ps.who + smoking + ras_index + RAS84" )

coxph_mv_fit_ri_rasact <- coxph( coxph_mv_form_ri_rasact, colData( se_uppsala ) )

anova_ri_rasact_res <- anova( coxph_mv_fit_ri_rasact, coxph_mv_fit_bg )

coxph_mv_form_ri_rasact_forest <- as.formula( "Surv( OS_time/52*12, OS ) ~ sex + stage + ps.who + smoking + ras_index + RAS84" )
coxph_mv_fit_ri_rasact_forest <- coxph( coxph_mv_form_ri_rasact_forest, colData( se_uppsala ) )
res_mvar_ri_rasact <- format_coxph( coxph_mv_fit_ri_rasact_forest, factor_name = "RAS84" )
datatable( res_mvar_ri_rasact, rownames = FALSE )
```

### Multivariate forest plot

```{r mv_forest_plot}
plotdat <- res_mvar_rasact %>%
    mutate( pvalue = as.character( pvalue ) )
reference_levels <- c( "RSG-0", "stageI", "ps.who.0", "smokingnever", "sexfemale" )
add_rows <- data.frame( predictor = reference_levels, 
                       HR = rep( 1, length( reference_levels ) ) )
add_rows$upper.95 <- add_rows$lower.95 <- rep( 0, length( reference_levels ) )
add_rows$pvalue <- "reference"

plotdat <- bind_rows( list( plotdat, add_rows ) ) %>%
    mutate( predictor = factor( predictor,
                                levels = rev( c( "RSG-4", "RSG-3",
                                                "RSG-2", "RSG-1", "RSG-0",
                                                "stageIII", "stageII", "stageI",
                                                "ps.who2", "ps.who1", "ps.who.0",
                                                "smokingcurrent", "smokingex >1year", "smokingnever",
                                                "sexmale", "sexfemale" ) ) ) )

plotdat_gathered <- plotdat %>%
    gather( interval, value, -predictor, -HR, -pvalue )

gg <- ggplot( plotdat_gathered, aes( y = as.numeric( predictor ), x = HR ) ) +
    geom_rect( data = data.frame( x1 = 0, x2 = max( plotdat$upper_95, na.rm = TRUE ),
                                 y1 = c( 2.5, 8.5 ), y2 = c( 5.5, 11.5 ) ),
              aes( xmin = x1, xmax = x2, ymin = y1, ymax = y2 ),
              fill = "grey", alpha = 0.4, inherit.aes = FALSE ) +
    geom_point( shape = 23, size = 3, fill = "black" ) +
    geom_line( data = filter( plotdat_gathered, interval %in% c( "lower_95", "upper_95" ) ),
              aes( y = as.numeric( predictor ), x = value, group = predictor ) ) +
    geom_vline( xintercept = 1, linetype = "dashed" ) +
    scale_x_continuous( breaks = c( 0.125, 0.25, 0.5, 1, 2, 4, 8, 16, 32 ), trans = "log",
                        expand = c( 0, 0) ) +
    scale_y_continuous( breaks = 1:nrow( plotdat ), labels = levels( plotdat$predictor ),
                       sec.axis = sec_axis( ~., breaks = 1:nrow( plotdat ),
                                           labels = plotdat$pvalue[ order( plotdat$predictor ) ] ) ) +
    plot_formatter( )

print( gg )
```

```{r render_mv_forest_plot,results='hide'}
cairo_pdf( file = file.path( adat$plot.path, "multivar.pdf" ), width = 6, height = 3 )
print( gg )
dev.off( )
```

### All signatures

Here we run the multivariate analysis against the parent signature
clusterings. We find that RAS84 is the only signature to produce RGSs
with progostic qualities beyond traditional clinical markers. 

```{r mv_uppsala_parent_sigs}
mvsur_uppsala_res_l <- map( parent_sigs, function( sig_n ) {
    form_string <- paste( "Surv( OS_time/52*12, OS ) ~ age + sex + stage + ps.who + smoking +", sig_n )
    coxph_form <- as.formula( form_string )
    coxph_fit <- coxph( coxph_form, colData( se_uppsala ) )
    format_coxph( coxph_fit, factor_name = sig_n )
} )
names( mvsur_uppsala_res_l ) <- parent_sigs

results$mvsurv_RSG_uppsala <- mvsur_uppsala_res_l %>%
    bind_rows( .id = "signature" ) %>%
    filter( grepl( "RSG", predictor ) ) %>%
    select( signature, predictor, HR, lower_95, upper_95, pvalue ) %>%
    mutate( signature = factor( signature, levels = c( "RAS84", parent_sigs[ -6 ] ) ) )

plotdat <- results$mvsurv_RSG_uppsala
mv_surv_gg <- ggplot( plotdat,
                      aes( x = HR, y = -log10( pvalue ), color = signature, label = predictor ) ) +
    geom_point( size = 2 ) +
    geom_point( data = subset( plotdat, signature == "RAS84" ),
               aes( x = HR, y = -log10( pvalue ) ),
               size = 3 ) +
    geom_text_repel( data = subset( plotdat, signature == "RAS84" ),
                    aes( x = HR, y = -log10( pvalue ), label = predictor ) ) +
    geom_hline( yintercept = -log10( 0.05 ), color = my_orange, linetype = "dashed" ) +
    plot_formatter( )

print( mv_surv_gg )
cairo_pdf( file = file.path( adat$plot.path, "mvcox_parent_sigs_volcano.pdf" ),
          width = 5, height = 4 )
print( mv_surv_gg )
dev.off( )
```
```{r output_results}
write.xlsx( results, file.path( adat$analysis.path, "coxph_RSG_results.xlsx" ) )
```

## Nagy et. al. 5 gene RAS signature

Here we test the five gene RAS prognostic signature publised by [Nagy
et al]
(https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5299512/pdf/IJC-140-930.pdf).

```{r nagy_uppsala}
genes_nagy <- c( "FOXRED2", "KRAS", "TOP1", "PEX3", "ABL2" )

sig_exprs <- assays( se_uppsala )$vst %>%
                          as.data.frame( ) %>%
                          rownames_to_column( var = "ensembl_gene_id" ) %>%
                          left_join( as.data.frame( rowData( se_uppsala ) ), by = "ensembl_gene_id" ) %>%
                          filter( external_gene_name %in% genes_nagy ) %>%
                          gather( title, value, -ensembl_gene_id, -external_gene_name) %>%
                          group_by( title ) %>%
                          summarize( nagy = mean( value ) ) %>%
                          left_join( as.data.frame( colData( se_uppsala )[, c( "title", "OS", "OS_time" ) ] ),
                                    by = "title" ) %>%
                          mutate( nagy_high = as.factor( nagy > median( nagy ) ) )

nagy_coxph <- coxph( Surv( OS_time/52*12, OS ) ~ nagy_high, sig_exprs )

fit <- survfit(  Surv( OS_time/52*12, OS ) ~ nagy_high, sig_exprs )
gg <- ggsurvplot( fit, data = sig_exprs, pval = TRUE,
                 palette = c( my_blue, my_red ),
                 xlab = "Time / months" )
print( gg )
cairo_pdf( file = file.path( adat$plot.path, "nagy_uppsala.pdf" ),
              width = 5, height = 4 )
print( gg )
dev.off()
```

# Session Info

```{r session_info}
sessionInfo()
```

# Small Signature

## SVM classifier approach

Here we take the SVM models created by using the RF ranked RAS84 genes
and the TCGA data. We used each of these models to classify the
Uppsala data. We ran the multivariate OS analysis on these different
RAG classifications. 

Classifying does not work

```{r small_sig_svm_multivariate}
RF_rank_models_l <- readRDS( file = file.path( "..", "classifiers", "RF_ranked_svm_models_l.rds" ) )

RAG_classes <- map( RF_rank_models_l, function( m ) {
    genes_f <- rowData( se_uppsala_ras84 )$svm %in% predictors( m )
    se_uppsala_local <- se_uppsala_ras84[ genes_f, ]
    mat <- assays( se_uppsala_local )$z
    rownames( mat ) <- rowData( se_uppsala_local )$svm
    predict( m, t( mat ) )
} )

RAG_coxph_multiv_l <- map( RAG_classes, function( RAG_vec ) {
    OS_dat <- colData( se_uppsala ) %>%
        as.data.frame( ) %>%
        mutate( RAG = RAG_vec )
    coxph_mv_form_rasact_forest <- as.formula( "Surv( OS_time/52*12, OS ) ~ sex + stage + ps.who + smoking + RAG" )
    coxph( coxph_mv_form_rasact_forest, OS_dat )
} )

map( RAG_coxph_multiv_l, function( coxph_multi ) {
    summary( coxph_multi )$coef[ "RAGRAG-3", ]
} )
```

## Clustering

We tried a clustering approach.

```{r small_sig_clustering_multivariate}
RF_genes_ranked <- read.table( file = file.path( "..", "RAS_short_signature", "TCGA", "LUAD", "RF_ranked_RAS84_genes.txt" ), sep = "\t", header = TRUE, stringsAsFactors = FALSE )

small_sigs_RF_ranked <- map( 6:nrow( RF_genes_ranked ), function( i ) {
    RF_genes_ranked$genes[ 1:i ]
} )
names( small_sigs_RF_ranked ) <- as.character( 6:nrow( RF_genes_ranked ) )

samp_clust_l <- lapply( small_sigs_RF_ranked, function( sig_genes ) {
    sig_f <- rowData( se_uppsala_ras84 )$svm %in% sig_genes
    vst_mat <- assays( se_uppsala_ras84 )$vst[ sig_f, ]
    hc <- hclust( dist( t( vst_mat ) ), method = "ward.D2" )
    ct_df <- cutree( hc, k = cluster_no ) %>%
        as.data.frame( ) %>%
        dplyr::rename( ct_cluster = 1 ) %>%
        rownames_to_column( var = "barcode" )
    ct_means <- vst_mat %>%
        as.data.frame( ) %>%
        tidyr::gather( barcode, value ) %>%
        left_join( ct_df, by = "barcode" ) %>%
        group_by( ct_cluster ) %>%
        dplyr::summarize( mean = mean( value ) ) %>%
        arrange( mean ) %>%
        mutate( RAG_5 = paste( "RAG", 0:( cluster_no - 1 ), sep = "-" ) )
    ct_df %>%
        left_join( ct_means, by = "ct_cluster" ) %>%
        mutate( RAG_5 = factor( RAG_5 ) ) %>%
        dplyr::select( barcode, RAG_5 )
} )

RAG_coxph_multiv_l <- map( samp_clust_l, function( RAG_df ) {
    RAG_vec <- RAG_df$RAG_5
    OS_dat <- colData( se_uppsala ) %>%
        as.data.frame( ) %>%
        mutate( RAG = RAG_vec )
    coxph_mv_form_rasact_forest <- as.formula( "Surv( OS_time/52*12, OS ) ~ sex + stage + ps.who + smoking + RAG" )
    coxph( coxph_mv_form_rasact_forest, OS_dat )
} )

RAG_coxph_multiv_df <- map( RAG_coxph_multiv_l, format_coxph, factor_name = "RAG" ) %>%
    bind_rows( .id = "RF_rank" ) %>%
    dplyr::filter( predictor == "RAG-4" ) %>%
    mutate( RF_rank = as.numeric( RF_rank ) ) %>%
    mutate( fdr = p.adjust( pvalue, method = "fdr" ) ) %>%
    mutate( sig_label = fdr < 0.05 ) 

RAG_coxph_multiv_df %>%
    write.table( file = file.path( adat$analysis.path, "RAG4_coxph_multiv_small_sig_res_Uppsala.txt" ),
                 row.names = FALSE, quote = FALSE )

small_sig_coxph_gg <- RAG_coxph_multiv_df %>%
    ggplot( aes( x = RF_rank, y = HR ) ) +
    geom_line( ) +
    geom_point( size = 3, aes( color = sig_label ) ) +
    scale_colour_manual( values = c( "grey", "orange" ) ) +
    scale_linetype_manual( values = c( "solid", "dotted", "dotted" ) ) +
    labs( x = "Signature gene count", y = "Hazard Ratio", color = "significant",
         title = "RAG-4 univariate coxph TCGA" ) +
    plot_formatter( )

cairo_pdf( file = file.path( adat$plot.path, "small_sig_multivar_coxph.pdf" ),
          width = 6, height = 3 )
print( small_sig_coxph_gg )
dev.off( )

samp_clust_df <- map( samp_clust_l, function( x ) x$RAG_5 ) %>%
    bind_cols( ) %>%
    as.data.frame( )
samp_clust_df$barcode <- samp_clust_l[[ 1 ]]$barcode
```

```{r forest_plot_38_genes}
sig_n <- "RAG"
plotdat <- RAG_coxph_multiv_l$'38' %>%
    format_coxph( factor_name = "RAG" ) %>%
    mutate( pvalue = as.character( pvalue ) )
reference_levels <- c( "RAG-0", "stageI", "ps.who.0", "smokingnever", "sexfemale" )
add_rows <- data.frame( predictor = reference_levels, 
                       HR = rep( 1, length( reference_levels ) ) )
add_rows$upper.95 <- add_rows$lower.95 <- rep( 0, length( reference_levels ) )
add_rows$pvalue <- "reference"

plotdat <- bind_rows( list( plotdat, add_rows ) ) %>%
    mutate( predictor = factor( predictor,
                                levels = rev( c( "RAG-4", "RAG-3",
                                                "RAG-2", "RAG-1", "RAG-0",
                                                "stageIII", "stageII", "stageI",
                                                "ps.who2", "ps.who1", "ps.who.0",
                                                "smokingcurrent", "smokingex >1year", "smokingnever",
                                                "sexmale", "sexfemale" ) ) ) )

plotdat_gathered <- plotdat %>%
    gather( interval, value, -predictor, -HR, -pvalue )

gg <- ggplot( plotdat_gathered, aes( y = as.numeric( predictor ), x = HR ) ) +
    geom_rect( data = data.frame( x1 = 0, x2 = max( plotdat$upper_95, na.rm = TRUE ),
                                 y1 = c( 2.5, 8.5 ), y2 = c( 5.5, 11.5 ) ),
              aes( xmin = x1, xmax = x2, ymin = y1, ymax = y2 ),
              fill = "grey", alpha = 0.4, inherit.aes = FALSE ) +
    geom_point( shape = 23, size = 3, fill = "black" ) +
    geom_line( data = filter( plotdat_gathered, interval %in% c( "lower_95", "upper_95" ) ),
              aes( y = as.numeric( predictor ), x = value, group = predictor ) ) +
    geom_vline( xintercept = 1, linetype = "dashed" ) +
    scale_x_continuous( breaks = c( 0.125, 0.25, 0.5, 1, 2, 4, 8, 16, 32 ), trans = "log",
                        expand = c( 0, 0 ) ) +
    scale_y_continuous( breaks = 1:nrow( plotdat ), labels = levels( plotdat$predictor ),
                       sec.axis = sec_axis( ~., breaks = 1:nrow( plotdat ),
                                           labels = plotdat$pvalue[ order( plotdat$predictor ) ] ) ) +
    plot_formatter( )
print( gg )
```
```{r render_mv_forest_plot,results='hide'}
cairo_pdf( file = file.path( adat$plot.path, "small_sg_38_multivar_uppsala.pdf" ), width = 6, height = 3 )
print( gg )
dev.off( )
```

## coxphMIC TCGA genes applied to Uppsala

No significant association with outcome.

```{r coxphMIC_TCGA_to_Uppsala}
sig_f <- rowData( se_uppsala_ras84 )$TCGA_gene_symbol %in% coxphMIC_genes
se_uppsala_ras84$mic_ri <- colMeans( assays( se_uppsala_ras84 )$vst[ sig_f, ] )

OS_dat <- colData( se_uppsala_ras84 ) %>%
    as.data.frame( )
coxph_mv_form_rasact_forest <- as.formula( "Surv( OS_time/52*12, OS ) ~ sex + stage + ps.who + smoking + mic_ri" )
coxph_mv_mic_uppsala <- coxph( coxph_mv_form_rasact_forest, OS_dat )
res_coxph_mv_mic_uppsala <- format_coxph( coxph_mv_mic_uppsala, factor_name = "" )

plotdat <- res_coxph_mv_mic_uppsala %>%
    mutate( pvalue = as.character( pvalue ) )
reference_levels <- c( "stageI", "ps.who.0", "smokingnever", "sexfemale" )
add_rows <- data.frame( predictor = reference_levels, 
                       HR = rep( 1, length( reference_levels ) ) )
add_rows$upper.95 <- add_rows$lower.95 <- rep( 0, length( reference_levels ) )
add_rows$pvalue <- "reference"

plotdat <- bind_rows( list( plotdat, add_rows ) ) %>%
    mutate( predictor = factor( predictor,
                                levels = rev( c( "mic_ri",
                                                "stageIII", "stageII", "stageI",
                                                "ps.who2", "ps.who1", "ps.who.0",
                                                "smokingcurrent", "smokingex >1year", "smokingnever",
                                                "sexmale", "sexfemale" ) ) ) )

plotdat_gathered <- plotdat %>%
    gather( interval, value, -predictor, -HR, -pvalue )

gg <- ggplot( plotdat_gathered, aes( y = as.numeric( predictor ), x = HR ) ) +
    geom_rect( data = data.frame( x1 = 0, x2 = max( plotdat$upper_95, na.rm = TRUE ),
                                 y1 = c( 2.5, 8.5 ), y2 = c( 5.5, 11.5 ) ),
              aes( xmin = x1, xmax = x2, ymin = y1, ymax = y2 ),
              fill = "grey", alpha = 0.4, inherit.aes = FALSE ) +
    geom_point( shape = 23, size = 3, fill = "black" ) +
    geom_line( data = filter( plotdat_gathered, interval %in% c( "lower_95", "upper_95" ) ),
              aes( y = as.numeric( predictor ), x = value, group = predictor ) ) +
    geom_vline( xintercept = 1, linetype = "dashed" ) +
    scale_x_continuous( breaks = c( 0.125, 0.25, 0.5, 1, 2, 4, 8, 16, 32 ), trans = "log",
                        expand = c( 0, 0) ) +
    scale_y_continuous( breaks = 1:nrow( plotdat ), labels = levels( plotdat$predictor ),
                       sec.axis = sec_axis( ~., breaks = 1:nrow( plotdat ),
                                           labels = plotdat$pvalue[ order( plotdat$predictor ) ] ) ) +
    plot_formatter( )


cairo_pdf( file = file.path( adat$plot.path, "uppsala_coxphMIC_11_genes_forest.pdf" ),
          width = 6, height = 3 )
print( gg )
dev.off()
```

# RAS 84 Classifaction ~ TNM

```{r RAS84_TNM_mosaic}
tab_dat <- colData( se_uppsala )[, c( "RAS84", "stage" ) ] %>%
    as.data.frame( ) %>%
    table( )

cairo_pdf( file = file.path( adat$plot.path, "mosaic_RAG_TNM_uppsala.pdf" ) )
print( mosaic( tab_dat, shade = TRUE, legend = TRUE, main = "RAG ~ TNM",
              gp = shading_hsv,
              gp_args = list( h = c(28/360, 203/360 ), s = c( 1, 0 ), v = c( 1, 0.5 ),
                             interpolate = c( 2, 4 ) ) ) )
dev.off( )
```
