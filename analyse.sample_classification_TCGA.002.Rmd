---
title: "RAS84 signature sample classification of TCGA LUAD cohort"
author: "philip.east@crick.ac.uk"
date: "12/02/2019"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script classifies TCGA samples using the RAS84 signature
constructed during the validate_signatures_CCLE
analysis. Classification groups are described and collorates across
the groupings are reported.

```{r r_init,message=FALSE}
library( affy )
library( limma )
library( reshape2 )
library( scales )
library( RColorBrewer )
library( ComplexHeatmap )
library( gplots )
library( gridExtra )
library( ggthemes )
library( Hmisc )
library( vcd )
library( UpSetR )
library( monocle )
library( pls )
library( DESeq2 )
library( circlize )
library( ggforce )
library( openxlsx )
library( tidyverse )
library( ggrepel )
```

# Introduction

Here we classify TCGA `r tumour` patients using our RAS84 expression
signature. We use a hierarchical clustering approach with a ward.D2
agglomeration method. We find that five clusters produced a low RAS
activity cluster with a very low KRAS mutation rate. We go on to show
other oncogenic mutations that correlate with this clustering pattern.

# Project Settings

We run the classification using the RAS84 signature against the `r
tumour` cohort from TCGA.  We produce five RAS activity patient clusters.

# Load and process TCGA data

Load the TCGA `r tumour` SummarizedExperiment object from the GDC
legacy download. These objects contain the TCGA data as downloaded. We
go on to add sample classification labels latter. 

```{r tcga_se}
se_t_file <- "se_t_LUAD.RNA-Seq.legacy.biolinks.rda" )
load( file = se_t_file )
rowData( se_t )$gene_symbol <- sub( "\\|.*", "", rowData( se_t )$id )
```

# RAS Signatures

Read in the RAS84 signature genes and the parent signatures.

```{r ras84_sig}
SIG_HOME <- "signatures"
init.signatures <- function( ) {
    krasSigNames <- sub( "\\.csv", "", dir( SIG_HOME ) )
    signatures <- lapply( krasSigNames, function( sigFile ) {
        read.table( file = file.path( SIG_HOME, paste( sigFile, "csv", sep = "." ) ),
                             sep = "\t", stringsAsFactors = FALSE )[, 1 ]
    } ) %>% setNames( make.names( krasSigNames ) )
    signatures
}
RAS84_signature_map <- read.xlsx( file.path( SIG_HOME, "RAS84_feature_map.xlsx" ) )

signatures <- init.signatures()
signatures$RAS84 <- RAS84_signature_map$TCGA_gene_symbol
```

# Classify samples

We classify the samples using hierarchical clustering approach with a
ward.D2 agglomeration method. We use cutree to cut the resulting
dendrogram into five clusters. We label the clusters RAG0-4 depending
on the mean expression across the clusters, with RAG4 being the highest.

```{r classification}
samp_clust_l <- lapply( signatures, function( sig_genes ) {
    sig_f <- rowData( se_t )$gene_symbol %in% sig_genes
    vst_mat <- assays( se_t )$vst[ sig_f, ]
    hc <- hclust( dist( t( vst_mat ) ), method = "ward.D2" )
    ct_df <- cutree( hc, k = cluster_no ) %>%
        as.data.frame( ) %>%
        dplyr::rename( ct_cluster = 1 ) %>%
        rownames_to_column( var = "barcode" )
    ct_means <- vst_mat %>%
        as.data.frame( ) %>%
        tidyr::gather( barcode, value ) %>%
        left_join( ct_df, by = "barcode" ) %>%
        group_by( ct_cluster ) %>%
        dplyr::summarize( mean = mean( value ) ) %>%
        arrange( mean ) %>%
        mutate( RAG_5 = paste( "RAG", 0:( cluster_no - 1 ), sep = "-" ) )
    ct_df %>%
        left_join( ct_means, by = "ct_cluster" ) %>%
        mutate( RAG_5 = factor( RAG_5 ) ) %>%
        dplyr::select( barcode, RAG_5 )
} )

samp_clust_df <- map( samp_clust_l, function( x ) x$RAG_5 ) %>%
    bind_cols( ) %>%
    as.data.frame( )
samp_clust_df$barcode <- samp_clust_l[[ 1 ]]$barcode

colData( se_t ) <- colData( se_t ) %>%
    as.data.frame( ) %>%
    left_join( samp_clust_df, by = "barcode" ) %>%
    DataFrame( row.names = .$barcode )
saveRDS( se_t, file.path( "data", "se_t.rds" ) )
```
